<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{fragments/layout}">
<head lang="ko">
<meta charset="UTF-8">
<title>ë ˆì‹œí”¼ ìˆ˜ì •</title>

<link rel="stylesheet"
	href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">

<style>
    body {
        font-family: 'Pretendard', system-ui, -apple-system, sans-serif;
        background-color: #fcfcfc;
        color: #4A3728;
    }

    .modify-wrapper {
        max-width: 850px;
        margin: 50px auto;
        padding: 40px;
        background: #ffffff;
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(139, 69, 19, 0.08);
        border: 1px solid #f1e4d3;
    }

    h3.page-title {
        color: #4A3728;
        font-weight: 800;
        font-size: 1.8rem;
        margin-bottom: 40px;
        border-bottom: 3px solid #FDF5E6;
        padding-bottom: 15px;
    }

    .section-label {
        font-weight: 700;
        color: #8B4513;
        font-size: 1.1rem;
        margin-bottom: 12px;
        display: block;
    }

    /* ì…ë ¥ì°½ ìŠ¤íƒ€ì¼ */
    .form-control, .form-select {
        border-radius: 12px;
        border: 1px solid #D2B48C;
        padding: 12px 15px;
        transition: all 0.3s ease;
    }

    .form-control:focus, .form-select:focus {
        border-color: #8B4513;
        box-shadow: 0 0 0 0.2rem rgba(139, 69, 19, 0.1);
        outline: none;
    }

    /* ì¹´ë“œ ë° í–‰ ìŠ¤íƒ€ì¼ */
    .step-row, .card {
        background-color: #FDFDFD;
        border: 1px solid #EADDCA !important;
        border-radius: 15px !important;
        padding: 20px !important;
        margin-bottom: 15px;
    }

    /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .btn-warning {
        background-color: #8B4513 !important;
        border: none !important;
        color: white !important;
        font-weight: 700 !important;
        padding: 12px 30px !important;
        border-radius: 12px !important;
    }

    .btn-secondary {
        padding: 12px 30px !important;
        border-radius: 12px !important;
        font-weight: 600;
    }

    .btn-outline-primary {
        color: #8B4513 !important;
        border-color: #8B4513 !important;
        background: #fff !important;
        font-weight: 600;
    }

    .btn-outline-primary:hover {
        background: #8B4513 !important;
        color: #fff !important;
    }

    .btn-outline-success {
        color: #2E7D32 !important;
        border-color: #A5D6A7 !important;
        font-weight: 600;
    }

    .btn-outline-success:hover {
        background: #E8F5E9 !important;
    }

    .btn-danger {
        border-radius: 10px !important;
    }

    .mb-section {
        margin-bottom: 35px;
    }
    
    img {
        border-radius: 12px;
        margin-top: 10px;
        border: 1px solid #eee;
    }
</style>
</head>

<body>

	<div layout:fragment="content" class="container mt-5">
        <div class="modify-wrapper">
		    <h3 class="page-title">ğŸ´ ë ˆì‹œí”¼ ìˆ˜ì •</h3>

		    <form th:action="@{/recipes/modify}" method="post"
			    enctype="multipart/form-data">

                <input type="hidden" th:name="${_csrf.parameterName}"
                    th:value="${_csrf.token}" />

                <input type="hidden" name="recipeId" th:value="${recipe.recipeId}" />

                <div class="mb-section">
                    <label class="section-label">ë ˆì‹œí”¼ ì œëª© *</label> 
                    <input type="text" class="form-control" name="title" th:value="${recipe.title}" required>
                </div>

                <div class="row mb-section">
                    <div class="col-md-6 mb-3">
                        <label class="section-label">ì¹´í…Œê³ ë¦¬ *</label> 
                        <select name="category" class="form-select" required>
                            <option value="2" th:selected="${recipe.category == 2}">í•œì‹</option>
                            <option value="3" th:selected="${recipe.category == 3}">ì–‘ì‹</option>
                            <option value="4" th:selected="${recipe.category == 4}">ì¤‘ì‹</option>
                            <option value="5" th:selected="${recipe.category == 5}">ì¼ì‹</option>
                            <option value="6" th:selected="${recipe.category == 6}">ë””ì €íŠ¸</option>
                            <option value="7" th:selected="${recipe.category == 7}">ê±´ê°•ì‹</option>
                            <option value="8" th:selected="${recipe.category == 8}">ê¸°íƒ€</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="section-label">ë‚œì´ë„ *</label> 
                        <select name="difficulty" class="form-select" required>
                            <option value="ì‰¬ì›€" th:selected="${recipe.difficulty == 'ì‰¬ì›€'}">ì‰¬ì›€</option>
                            <option value="ë³´í†µ" th:selected="${recipe.difficulty == 'ë³´í†µ'}">ë³´í†µ</option>
                            <option value="ì–´ë ¤ì›€" th:selected="${recipe.difficulty == 'ì–´ë ¤ì›€'}">ì–´ë ¤ì›€</option>
                        </select>
                    </div>
                </div>

                <div class="row mb-section">
                    <div class="col-md-6 mb-3">
                        <label class="section-label">ì¡°ë¦¬ ì‹œê°„(ë¶„)</label> 
                        <input type="number" class="form-control" name="cookTime" th:value="${recipe.cookTime}">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="section-label">ì¸ë¶„</label> 
                        <input type="number" class="form-control" name="servings" th:value="${recipe.servings}">
                    </div>
                </div>

                <div class="mb-section">
                    <label class="section-label">ğŸ–¼ï¸ ëŒ€í‘œ ì´ë¯¸ì§€</label>
                    <div class="mb-3" th:if="${recipe.image != null}">
                        <small class="text-muted d-block mb-2">í˜„ì¬ ì´ë¯¸ì§€:</small>
                        <img th:src="@{/upload/{img}(img=${recipe.image})}" style="max-width: 250px;">
                    </div>
                    <input type="file" class="form-control" name="imageFile"> 
                    <input type="hidden" name="image" th:value="${recipe.image}">
                </div>

                <div class="mb-section">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <label class="section-label mb-0">ë ˆì‹œí”¼ ì„¤ëª… *</label>
                        <button type="button" class="btn btn-sm btn-outline-success" id="autoDescSimpleBtn">âœ¨ AI ê°„ë‹¨ ì„¤ëª…</button>
                    </div>
                    <textarea class="form-control" id="description" name="description"
                        rows="3" required th:text="${recipe.description}"></textarea>
                </div>

                <hr class="my-4" style="border-color: #EADDCA;">

                <div class="mb-section">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <label class="section-label mb-0">ğŸ§‚ ì¬ë£Œ ì •ë³´ *</label>
                        <button type="button" class="btn btn-sm btn-outline-primary" id="addIngredientBtn">+ ì¬ë£Œ ì¶”ê°€</button>
                    </div>

                    <div id="ingredientsContainer">
                        <div class="row g-2 mb-2 ingredient-row align-items-center" th:each="ing, stat : ${ingredients}">
                            <div class="col-5">
                                <input class="form-control" th:name="'ingredients['+${stat.index}+'].ingreName'"
                                    th:value="${ing.ingreName}" required>
                            </div>
                            <div class="col-5">
                                <input class="form-control" th:name="'ingredients['+${stat.index}+'].ingreNum'"
                                    th:value="${ing.ingreNum}" required>
                            </div>
                            <div class="col-2 d-grid">
                                <button type="button" class="btn btn-danger btn-remove-ingre">ì‚­ì œ</button>
                            </div>
                        </div>
                    </div>
                </div>

                <hr class="my-4" style="border-color: #EADDCA;">

                <div class="mb-section">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <label class="section-label mb-0">ğŸ‘¨â€ğŸ³ ì¡°ë¦¬ ë°©ë²• *</label>
                        <div>
                            <button type="button" class="btn btn-sm btn-outline-success me-2" id="autoStepBtn">ğŸ¤– AI ë‹¨ê³„ ìƒì„±</button>
                            <button type="button" class="btn btn-sm btn-outline-primary" id="addStepBtn">+ ë‹¨ê³„ ì¶”ê°€</button>
                        </div>
                    </div>

                    <div id="stepsContainer">
                        <div class="card step-row" th:each="st, stat : ${steps}">
                            <label class="section-label" style="font-size: 0.9rem;" th:text="${stat.index + 1} + 'ë‹¨ê³„'"></label>
                            <textarea class="form-control mb-3" th:name="'steps['+${stat.index}+'].stepDesc'" 
                                rows="2" required th:text="${st.stepDesc}"></textarea>

                            <div th:if="${st.stepImage != null}" class="mb-3">
                                <img th:src="@{/upload/{img}(img=${st.stepImage})}" style="max-width: 200px;"> 
                                <input type="hidden" th:name="'steps['+${stat.index}+'].stepImage'" th:value="${st.stepImage}">
                            </div>

                            <input type="file" name="stepImages" class="form-control">
                            <div class="text-end mt-2">
                                <button type="button" class="btn btn-sm btn-danger btn-remove-step">ë‹¨ê³„ ì‚­ì œ</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mb-section">
                    <label class="section-label">ğŸ”— ë ˆì‹œí”¼ ì°¸ê³  URL</label> 
                    <input type="text" class="form-control" name="rUrl" th:value="${recipe.rUrl}">
                </div>

                <input type="hidden" name="status" value="PUBLIC">

                <div class="text-center mt-5">
                    <button type="submit" class="btn btn-warning shadow-sm">ìˆ˜ì • ì €ì¥</button>
                    <button type="button" class="btn btn-secondary shadow-sm ms-2" onclick="saveTemp()">ì„ì‹œì €ì¥</button>
                </div>
		    </form>
        </div>

		<script>
/* ===========================
   ê¸°ì¡´ ìŠ¤í¬ë¦½íŠ¸ ë¡œì§ (ë³€ê²½ ì—†ìŒ)
=========================== */
const ingreBox = document.getElementById('ingredientsContainer');
const stepBox = document.getElementById('stepsContainer');

function reindexIngredients(){
  document.querySelectorAll('.ingredient-row').forEach((row, i)=>{
    row.querySelector('[name$="ingreName"]').name = `ingredients[${i}].ingreName`;
    row.querySelector('[name$="ingreNum"]').name  = `ingredients[${i}].ingreNum`;
  });
}

function reindexSteps(){
  document.querySelectorAll('.step-row').forEach((row, i)=>{
    row.querySelector('label').textContent = `${i+1}ë‹¨ê³„`;
    row.querySelector('textarea').name = `steps[${i}].stepDesc`;
  });
}

// ì¬ë£Œ ì‚­ì œ ì´ë²¤íŠ¸ ìœ„ì„
ingreBox.onclick = e => {
    if (e.target.classList.contains('btn-remove-ingre')) {
        e.target.closest('.ingredient-row').remove();
        reindexIngredients();
    }
};

// ë‹¨ê³„ ì‚­ì œ ì´ë²¤íŠ¸ ìœ„ì„
stepBox.onclick = e => {
    if (e.target.classList.contains('btn-remove-step')) {
        e.target.closest('.step-row').remove();
        reindexSteps();
    }
};

// ì¬ë£Œ ì¶”ê°€
document.getElementById('addIngredientBtn').onclick = () => {
    const idx = document.querySelectorAll('.ingredient-row').length;
    const div = document.createElement('div');
    div.className = 'row g-2 mb-2 ingredient-row align-items-center';
    div.innerHTML = `
      <div class="col-5">
        <input class="form-control" name="ingredients[${idx}].ingreName" required>
      </div>
      <div class="col-5">
        <input class="form-control" name="ingredients[${idx}].ingreNum" required>
      </div>
      <div class="col-2 d-grid">
        <button type="button" class="btn btn-danger btn-remove-ingre">ì‚­ì œ</button>
      </div>`;
    ingreBox.appendChild(div);
};

// ë‹¨ê³„ ì¶”ê°€
document.getElementById('addStepBtn').onclick = () => {
    const idx = document.querySelectorAll('.step-row').length;
    const div = document.createElement('div');
    div.className = 'card p-3 mb-3 step-row';
    div.innerHTML = `
      <label class="section-label" style="font-size: 0.9rem;">${idx + 1}ë‹¨ê³„</label>
      <textarea class="form-control mb-3" name="steps[${idx}].stepDesc" rows="2" required></textarea>
      <input type="file" name="stepImages" class="form-control">
      <div class="text-end mt-2">
        <button type="button" class="btn btn-sm btn-danger btn-remove-step">ë‹¨ê³„ ì‚­ì œ</button>
      </div>`;
    stepBox.appendChild(div);
};

/* ìë™ ìƒì„± fetch ë¡œì§ ë“± ê¸°ì¡´ ì½”ë“œ ìœ ì§€ */
document.getElementById('autoStepBtn').onclick = () => {
  const title = document.querySelector('[name="title"]').value;
  const shortDesc = document.getElementById('description').value;
  const ingredients = Array.from(document.querySelectorAll('[name$="ingreName"]')).map(el => el.value).filter(v => v);

  fetch('/recipes/auto-steps', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRF-TOKEN': document.querySelector('input[name="_csrf"]').value
    },
    body: JSON.stringify({ title, shortDesc, ingredients })
  })
  .then(res => res.json())
  .then(data => {
    const steps = data.steps.split('\n').filter(s => s.trim());
    stepBox.innerHTML = '';
    steps.forEach((s, i) => {
      const div = document.createElement('div');
      div.className = 'card p-3 mb-3 step-row';
      div.innerHTML = `
        <label class="section-label" style="font-size: 0.9rem;">${i+1}ë‹¨ê³„</label>
        <textarea class="form-control mb-3" name="steps[${i}].stepDesc" rows="2" required>${s}</textarea>
        <input type="file" name="stepImages" class="form-control">
        <div class="text-end mt-2">
            <button type="button" class="btn btn-sm btn-danger btn-remove-step">ë‹¨ê³„ ì‚­ì œ</button>
        </div>`;
      stepBox.appendChild(div);
    });
  });
};

document.getElementById('autoDescSimpleBtn').onclick = () => {
  const title = document.querySelector('[name="title"]').value;
  const ingredients = Array.from(document.querySelectorAll('[name$="ingreName"]')).map(el => el.value).filter(v => v);
  const steps = Array.from(document.querySelectorAll('[name$="stepDesc"]')).map(el => el.value).filter(v => v);

  fetch('/recipes/auto-description', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRF-TOKEN': document.querySelector('input[name="_csrf"]').value
    },
    body: JSON.stringify({ title, ingredients, steps, mode: 'simple' })
  })
  .then(res => res.json())
  .then(data => {
    document.getElementById('description').value = data.description;
  });
};

function saveTemp(){
  document.querySelector('input[name="status"]').value = 'TEMP';
  document.querySelector('form').submit();
}
</script>

	</div>
</body>
</html>