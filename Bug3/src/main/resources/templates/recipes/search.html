<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
   xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
   xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
   layout:decorate="~{fragments/layout}">
<head lang="ko">
<meta charset="UTF-8">
<meta name="_csrf" th:content="${_csrf.token}" />
<meta name="_csrf_header" th:content="${_csrf.headerName}" />
<meta name="isAuthenticated"
   th:content="${#authorization.expression('isAuthenticated()')}" />

<title>ë ˆì‹œí”¼ ê²€ìƒ‰</title>
<style>
/* ì „ì²´ ì»¨í…Œì´ë„ˆ ì—¬ë°± */
/* .main-recipe-container {
   padding: 40px 15px;
   background-color: #FDF5E6; /* ë°°ê²½ìƒ‰ í†µì¼ */
   
} */

/* ê²€ìƒ‰ ë°” ì˜ì—­ ë””ìì¸ ê°œì„  */
.search-category-bar {
   background: #ffffff; /* ë‚´ë¶€ ë°•ìŠ¤ëŠ” í°ìƒ‰ìœ¼ë¡œ ê¹”ë”í•˜ê²Œ */
   padding: 30px;
   border-radius: 15px;
   margin-bottom: 40px;
   box-shadow: 0 4px 15px rgba(139, 69, 19, 0.1); /* ë¸Œë¼ìš´ í†¤ ê·¸ë¦¼ì */
   border: 1px solid #EADDCA;
}

.search-label {
   color: #6F4E37;
   font-size: 1.2rem;
   margin-bottom: 15px;
   display: block;
}
/* 1. í˜ì´ì§• ë²„íŠ¼ ì†ê°€ë½ ëª¨ì–‘ ë° ìŠ¤íƒ€ì¼ ìœ ì§€ */
.pagination .page-link {
   color: #8B4513;
   background-color: #fff;
   border: 1px solid #D2B48C;
   cursor: pointer; /* ë§ˆìš°ìŠ¤ ì˜¬ë¦¬ë©´ ì†ê°€ë½ ëª¨ì–‘ */
   transition: all 0.2s ease;
}

.pagination .page-item.active .page-link {
   background-color: #8B4513;
   border-color: #8B4513;
   color: #FDF5E6;
   cursor: default; /* í™œì„±í™”ëœ í˜ì´ì§€ëŠ” ê¸°ë³¸ í¬ì¸í„° */
}

.pagination .page-link:hover {
   background-color: #F5DEB3; /* ì—°í•œ ë² ì´ì§€ìƒ‰ìœ¼ë¡œ í•˜ì´ë¼ì´íŠ¸ */
   color: #8B4513;
   border-color: #D2B48C;
}

/* 2. ì¹´í…Œê³ ë¦¬ ë° ì •ë ¬ ë²„íŠ¼ì—ë„ í¬ì¸í„° ì¶”ê°€ */
.filter-btn, .sort-btn {
   cursor: pointer !important;
}

/* 3. ë ˆì‹œí”¼ ì¹´ë“œ ì „ì²´ì— í¬ì¸í„° ì¶”ê°€ (ì´ë¯¸ ì„¤ì •ë˜ì–´ ìˆì§€ë§Œ í™•ì¸ì°¨) */
.recipe-card {
   cursor: pointer;
}

/* 4. ìƒíƒœ ë©”ì‹œì§€(ë¡œë”© ì¤‘) ë“±ì— í¬ì¸í„°ê°€ ìƒê¸°ì§€ ì•Šë„ë¡ ë°©ì§€ */
.status-msg {
   cursor: default;
}
/* ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì»¤ìŠ¤í…€ */
.btn-primary-theme {
   background-color: #8B4513 !important;
   border-color: #8B4513 !important;
   color: #FDF5E6 !important;
   font-weight: bold;
}

.btn-primary-theme:hover {
   background-color: #6F4E37 !important;
}

/* ì¹´í…Œê³ ë¦¬ ë²„íŠ¼ í•„í„° ìŠ¤íƒ€ì¼ */
.filter-btn {
   border-color: #D2B48C !important;
   color: #8B4513 !important;
   margin-bottom: 5px;
}

.filter-btn.active, .filter-btn:hover {
   background-color: #8B4513 !important;
   color: #FDF5E6 !important;
}

/* ì¹´ë“œ ì´ë¯¸ì§€ */
.recipe-card img {
   width: 100%;
   height: 220px;
   object-fit: cover;
   border-radius: 10px 10px 0 0;
}

/* ë ˆì‹œí”¼ ì¹´ë“œ ê°œì„  */
.recipe-card {
   border: none;
   border-radius: 12px;
   background: #fff;
   transition: all .3s ease;
   box-shadow: 0 2px 10px rgba(0, 0, 0, .05);
   height: 100%;
   margin-bottom: 10px;
}

.recipe-card:hover {
   transform: translateY(-8px);
   box-shadow: 0 12px 30px rgba(111, 78, 55, 0.15);
}

.card-content {
   padding: 20px;
}

.recipe-description {
   font-size: 0.9rem;
   color: #6c757d;
   height: 2.7em;
   overflow: hidden;
   text-overflow: ellipsis;
   display: -webkit-box;
   -webkit-line-clamp: 2;
   -webkit-box-orient: vertical;
}

/* ì¹´í…Œê³ ë¦¬ ë¼ë²¨ */
.category-label {
   background: #FDF5E6;
   color: #8B4513;
   padding: 4px 12px;
   border-radius: 20px;
   font-size: .8rem;
   font-weight: bold;
   border: 1px solid #D2B48C;
}

/* ë‚œì´ë„ í‘œì‹œ ë°•ìŠ¤ */
.difficulty-box {
   padding: 3px 8px;
   border-radius: 4px;
   font-size: 0.8rem;
}

.difficulty-easy {
   background: #E8F5E9;
   color: #2E7D32;
}

.difficulty-medium {
   background: #FFF3E0;
   color: #EF6C00;
}

.difficulty-hard {
   background: #FFEBEE;
   color: #C62828;
}

/* ì¢‹ì•„ìš” ë²„íŠ¼ */
.like-inline-btn.liked .heart {
   color: #e74c3c;
}
/* ì¢‹ì•„ìš” ë²„íŠ¼: ë°°ê²½ê³¼ í…Œë‘ë¦¬ ì™„ì „ ì œê±° */
.like-inline-btn {
   background: transparent !important; /* ë°°ê²½ íˆ¬ëª… */
   border: none !important; /* í…Œë‘ë¦¬ ì‚­ì œ */
   padding: 0 !important; /* ì—¬ë°± ì œê±° */
   cursor: pointer;
   display: inline-flex;
   align-items: center;
   gap: 4px; /* í•˜íŠ¸ì™€ ìˆ«ì ì‚¬ì´ ê°„ê²© */
   color: #6c757d; /* ê¸°ë³¸ ê¸€ììƒ‰ (íšŒìƒ‰) */
   transition: transform 0.2s ease;
}

/* í•˜íŠ¸ ì•„ì´ì½˜ ìŠ¤íƒ€ì¼ */
.like-inline-btn .heart {
   font-size: 1.0rem;
   transition: color 0.2s ease;
}

/* â¤ï¸ í™œì„±í™” ìƒíƒœ (ì¢‹ì•„ìš” ëˆŒë €ì„ ë•Œ) */
.like-inline-btn.liked {
   color: #dc3545 !important; /* ì „ì²´ ìƒ‰ìƒì„ ë¹¨ê°„ìƒ‰ìœ¼ë¡œ */
}

.like-inline-btn.liked .heart {
   color: #dc3545 !important;
}

/* ë§ˆìš°ìŠ¤ ì˜¬ë ¸ì„ ë•Œ ì‚´ì§ ì»¤ì§€ëŠ” íš¨ê³¼ë§Œ ë¶€ì—¬ */
.like-inline-btn:hover {
   transform: scale(1.1);
   background: transparent !important;
}
/* í˜ì´ì§€ë„¤ì´ì…˜ ìƒ‰ìƒ ë§ì¶¤ */
.pagination .page-link {
   color: #8B4513;
   background-color: #fff;
   border: 1px solid #D2B48C;
}

.pagination .page-item.active .page-link {
   background-color: #8B4513;
   border-color: #8B4513;
   color: #FDF5E6;
}

/* ìì—°ì–´ ì²˜ë¦¬ ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ */
#nlpLoading {
    font-size: 1.05rem;
    color: #8B4513;
    font-weight: bold;
}

#nlpLoading::after {
    content: '';
    display: inline-block;
    width: 1em;
    text-align: left;
    animation: dots 1.5s infinite;
}

/* ë¦¬ë·° ì„¹ì…˜ ì „ì²´ ë°•ìŠ¤ */
.review-section {
    background-color: #FDF5E6 !important; /* ì¡°ë¦¬ ìˆœì„œì™€ ë™ì¼í•œ ë°°ê²½ìƒ‰ */
    border: 1px solid #D2B48C !important; /* ë¸Œë¼ìš´í†¤ í…Œë‘ë¦¬ ì„  ì¶”ê°€ */
    border-radius: 8px;
    max-height: 400px;
    overflow-y: auto;
}

/* ê°œë³„ ë¦¬ë·° í•­ëª© í…Œë‘ë¦¬ ë° ê°„ê²© */
.review-item {
    border: 1px solid #EADDCA; /* ë¦¬ë·°ë¼ë¦¬ êµ¬ë¶„ë˜ëŠ” ì•ˆìª½ ë„¤ëª¨ ë°•ìŠ¤ ì„  */
    background-color: #ffffff; /* ê°€ë…ì„±ì„ ìœ„í•´ ê°œë³„ ë¦¬ë·°ëŠ” í°ìƒ‰ ë°•ìŠ¤ ì²˜ë¦¬ */
    margin-bottom: 10px;
    padding: 12px;
    border-radius: 6px;
}

.review-item:last-child {
    margin-bottom: 0;
}


@keyframes dots {
    0%   { content: ''; }
    33%  { content: '.'; }
    66%  { content: '..'; }
    100% { content: '...'; }
}


/* ê´‘ê³ ë¥¼ í¬í•¨í•  ì „ì²´ ì˜ì—­ ê¸°ì¤€ì  ì„¤ì • */
.main-recipe-container {
    position: relative; 
    padding: 40px 15px;
    background-color: #FDF5E6;
    min-height: 100vh;
}

/* ì „ì²´ ë°°ê²½ ê¸°ì¤€ ì„¤ì • */
.main-recipe-container {
    position: relative;
    padding: 40px 15px;
    background-color: #FDF5E6;
    min-height: 1000px; /* í˜ì´ì§€ê°€ ì§§ì•„ë„ ê´‘ê³  ì˜ì—­ í™•ë³´ */
}

/* ì‚¬ì´ë“œ ê´‘ê³ ë¥¼ ë‹´ëŠ” í° í‹€ */
.side-ad-wrapper {
    position: absolute;
    top: 40px; /* í—¤ë” ë°”ë¡œ ì•„ë˜ë¶€í„° ì‹œì‘ */
    width: 200px; /* ê´‘ê³  ê°€ë¡œ ì‚¬ì´ì¦ˆ ì¦ê°€ */
    display: flex;
    flex-direction: column;
    gap: 20px; /* ê´‘ê³ ì™€ ê´‘ê³  ì‚¬ì´ì˜ ìˆ˜ì§ ê°„ê²© */
    z-index: 10;
}

/* ê°œë³„ ê´‘ê³  ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
.ad-box {
    width: 100%;
    height: 600px; /* ê´‘ê³  ë†’ì´ */
    background-color: #ffffff;
    border: 1px solid #D2B48C;
    border-radius: 12px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    overflow: hidden;
}

/* ì™¼ìª½ ê´‘ê³  ë°°ì¹˜: ë³¸ë¬¸ì—ì„œ ë” ë©€ë¦¬ ë–¨ì–´ëœ¨ë¦¼ */
.left-sidebar {
    left: 50%;
    /* ì¤‘ì•™ì—ì„œ (ë³¸ë¬¸ ì ˆë°˜ 660px + ì—¬ë°± 60px + ê´‘ê³ ë„ˆë¹„ 200px) ë§Œí¼ ì´ë™ */
    margin-left: -920px; 
}

/* ì˜¤ë¥¸ìª½ ê´‘ê³  ë°°ì¹˜ */
.right-sidebar {
    right: 50%;
    margin-right: -920px;
}

.ad-label {
    font-size: 11px;
    color: #A0A0A0;
    margin: 8px 0;
    font-weight: bold;
    letter-spacing: 1px;
}

/* í•´ìƒë„ê°€ ë‚®ì•„ì§€ë©´ ë³¸ë¬¸ì„ ê°€ë¦¬ì§€ ì•Šë„ë¡ ìˆ¨ê¹€ ì²˜ë¦¬ */
@media (max-width: 1850px) {
    .side-ad-wrapper {
        display: none;
    }
}

</style>
</head>
<body>
   <div layout:fragment="content" class="main-recipe-container">
      <div class="container">
         
        <div class="side-ad-wrapper left-sidebar">
      <div class="ad-box">
         <span class="ad-label">ADVERTISEMENT</span>
         <img src="https://via.placeholder.com/200x550?text=Left+Ad+1" alt="ê´‘ê³ 1" style="width:100%;">
      </div>
      <div class="ad-box">
         <span class="ad-label">ADVERTISEMENT</span>
         <img src="https://via.placeholder.com/200x550?text=Left+Ad+2" alt="ê´‘ê³ 2" style="width:100%;">
      </div>
   </div>

   <div class="side-ad-wrapper right-sidebar">
      <div class="ad-box">
         <span class="ad-label">ADVERTISEMENT</span>
         <img src="https://via.placeholder.com/200x550?text=Right+Ad+1" alt="ê´‘ê³ 3" style="width:100%;">
      </div>
      <div class="ad-box">
         <span class="ad-label">ADVERTISEMENT</span>
         <img src="https://via.placeholder.com/200x550?text=Right+Ad+2" alt="ê´‘ê³ 4" style="width:100%;">
      </div>
   </div>
         
         
         <div th:if="${suggestion}" class="mb-3">
            <div class="alert alert-warning border-0 shadow-sm">
               ğŸ’¡ ê²€ìƒ‰ì–´ë¥¼ '<strong><span th:text="${suggestion}"></span></strong>'(ìœ¼)ë¡œ ë°”ê¿” ê²€ìƒ‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?
            </div>
         </div>
		 
		 <div class="recommend-box mb-5 p-4" style="background-color: #ffffff; border-radius: 20px; border: 2px dashed #D2B48C; box-shadow: 0 10px 25px rgba(139, 69, 19, 0.05);">
		     <div class="row align-items-center">
		         <div class="col-lg-3 mb-3 mb-lg-0">
		             <h4 class="fw-bold mb-1" style="color: #8B4513;">ğŸ² ì˜¤ëŠ˜ ë­ ë¨¹ì§€?</h4>
		             <p class="text-muted small mb-0">ë©”ë‰´ ê³ ë¯¼ ë!</p>
		         </div>
		         
		         <div class="col-lg-9">
		             <div class="row g-2 align-items-center">
		                 <div class="col-sm-auto me-2">
		                     <div class="form-check form-switch mb-0">
		                         <input class="form-check-input" type="checkbox" id="highQualityToggle" style="cursor:pointer;">
		                         <label class="form-check-label small fw-bold" for="highQualityToggle" style="color: #d35400; cursor:pointer; white-space: nowrap;">
		                             ğŸ”¥ ì¸ê¸°ê¸€ë§Œ
		                         </label>
		                     </div>
		                 </div>
		                 
		                 <div class="col-sm-3">
		                     <select id="recCategory" class="form-select border-2">
		                         <option value="">ì „ì²´ ì¹´í…Œê³ ë¦¬</option>
		                         <option value="2">í•œì‹</option>
		                         <option value="3">ì–‘ì‹</option>
		                         <option value="4">ì¤‘ì‹</option>
		                         <option value="5">ì¼ì‹</option>
		                         <option value="6">ë””ì €íŠ¸</option>
		                         <option value="7">ê±´ê°•ì‹</option>
		                         <option value="8">ê¸°íƒ€</option>
		                     </select>
		                 </div>
		                 
		                 <div class="col-sm-4">
		                     <input type="text" id="recKeyword" class="form-control border-2" placeholder="ì¬ë£Œë‚˜ ë©”ë‰´ëª…">
		                 </div>
		                 
		                 <div class="col-sm-2">
		                     <button type="button" id="recommendBtn" class="btn btn-primary-theme w-100 shadow-sm" style="white-space: nowrap;">
		                         ì¶”ì²œ!
		                     </button>
		                 </div>
		             </div>
		         </div>
		     </div>
		 </div>

			<div id="recommendDisplay" style="display:none;" class="mb-5">
			    <div class="card border-0 shadow-sm" style="background-color: #fff9f0; border: 1px solid #D2B48C !important; border-radius: 15px;">
			        <div class="card-body p-4">
			            <div class="d-flex align-items-center">
			                <div class="me-4">
			                    <img id="recImage" src="" alt="ì¶”ì²œ ë ˆì‹œí”¼" style="width: 120px; height: 120px; object-fit: cover; border-radius: 12px; border: 2px solid #fff;">
			                </div>
			                <div class="flex-grow-1">
			                    <div class="d-flex justify-content-between align-items-start">
			                        <div>
			                            <span class="badge bg-warning text-dark mb-2">âœ¨ ì˜¤ëŠ˜ì˜ ì¶”ì²œ ë©”ë‰´</span>
			                            <h4 id="recTitle" class="fw-bold mb-1" style="color: #8B4513;"></h4>
			                        </div>
			                        <button type="button" class="btn-close" onclick="$('#recommendDisplay').slideUp()"></button>
			                    </div>
			                    <p class="text-muted small mb-3">
			                        <span id="recNickname" class="fw-bold"></span> ë‹˜ ë ˆì‹œí”¼ | 
			                        ì¹´í…Œê³ ë¦¬: <span id="recCategoryName" class="text-primary"></span> | 
			                        ì¡°íšŒìˆ˜: <span id="recViews"></span>
			                    </p>
			                    <a href="#" id="recLink" class="btn btn-sm btn-primary-theme px-4">ë ˆì‹œí”¼ ë³´ëŸ¬ê°€ê¸°</a>
			                </div>
			            </div>
			        </div>
			    </div>
		 </div>

         <h3 class="mb-4 fw-bold" style="color: #4A3728;">
            ğŸ³ ë ˆì‹œí”¼ ì°¾ê¸° <small class="text-muted" style="font-size: 1rem;">(ì´
               <span id="recipeCount">0</span>ê°œ)
            </small>
         </h3>

         <div class="search-category-bar">
            <div class="row g-3 align-items-end">
               <div class="col-md-2">
                  <label class="form-label fw-bold text-muted small">ê²€ìƒ‰ ì¡°ê±´</label> <select
                     id="searchField" class="form-select border-2">
                     <option value="ALL">ì „ì²´</option>
                     <option value="TITLE">ì œëª©</option>
                     <option value="AUTHOR">ì‘ì„±ì</option>
                  </select>
               </div>
               <div class="col-md-7">
                  <label class="form-label fw-bold text-muted small">ë ˆì‹œí”¼ ì´ë¦„
                     ë˜ëŠ” ì¬ë£Œ</label>
                  <div class="input-group">
                     <input type="search"
                        class="form-control form-control-lg border-2" id="search"
                        placeholder="ë¬´ì—‡ì„ ì°¾ê³  ì‹¶ìœ¼ì‹ ê°€ìš”?">
                     <button class="btn btn-primary-theme px-4" id="searchBtn">ê²€ìƒ‰</button>
                  </div>
               </div>
               <div class="col-md-3 text-end">
                  <a href="javascript:void(0)" id="registerBtn"
                     class="btn btn-primary-theme btn-lg w-100 shadow-sm"> ë‚˜ë§Œì˜ ë ˆì‹œí”¼
                     ë“±ë¡ </a>
               </div>
            </div>

            <hr class="my-4" style="border-color: #EADDCA;">

            <div
               class="d-flex flex-wrap justify-content-between align-items-center gap-3">
               <div class="category-btns">
                  <button
                     class="btn btn-outline-secondary filter-btn active rounded-pill px-3"
                     data-filter="">ì „ì²´</button>
                  <button
                     class="btn btn-outline-secondary filter-btn rounded-pill px-3"
                     data-filter="2">í•œì‹</button>
                  <button
                     class="btn btn-outline-secondary filter-btn rounded-pill px-3"
                     data-filter="3">ì–‘ì‹</button>
                  <button
                     class="btn btn-outline-secondary filter-btn rounded-pill px-3"
                     data-filter="4">ì¤‘ì‹</button>
                  <button
                     class="btn btn-outline-secondary filter-btn rounded-pill px-3"
                     data-filter="5">ì¼ì‹</button>
                  <button
                     class="btn btn-outline-secondary filter-btn rounded-pill px-3"
                     data-filter="6">ë””ì €íŠ¸</button>
                  <button
                     class="btn btn-outline-secondary filter-btn rounded-pill px-3"
                     data-filter="7">ê±´ê°•ì‹</button>
                  <button
                     class="btn btn-outline-secondary filter-btn rounded-pill px-3"
                     data-filter="8">ê¸°íƒ€</button>
               </div>

               <div class="btn-group shadow-sm">
                  <button class="btn btn-light border btn-sm sort-btn active"
                     data-sort="LATEST">ìµœì‹ ìˆœ</button>
                  <button class="btn btn-light border btn-sm sort-btn"
                     data-sort="VIEWS">ì¡°íšŒìˆœ</button>
                  <button class="btn btn-light border btn-sm sort-btn"
                     data-sort="LIKES">ì¢‹ì•„ìš”ìˆœ</button>
               </div>
            </div>
         </div>

         <div class="row g-4" id="recipeCards">
            <div class="status-msg">ë ˆì‹œí”¼ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
         </div>
         <div id="nlpLoading" class="status-msg text-center my-4"
            style="display: none;">ğŸ¤– ìì—°ì–´ë¥¼ ì´í•´í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</div>


         <div class="mt-5 text-center" id="pagingArea"></div>
      </div>
      <script
         src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
      <script th:inline="javascript">
         const ctx = ""; 
         let currentCategory = null;
         let currentPage = 1;
         let currentSort = "LATEST";
         let lastScrollTop = 0;
         let isSearching = false;

/* =====================================================
 * ê²€ìƒ‰ ì‹¤í–‰
 * ===================================================== */
 function runSearch(page) {
     if (isSearching) return;
     isSearching = true;

     lastScrollTop = window.pageYOffset;
     currentPage = page || 1;

     const keyword = $("#search").val()?.trim() || "";
     const searchField = $("#searchField").val() || "ALL";
     const fields = (searchField === "ALL")
       ? ["TITLE", "AUTHOR", "DESCRIPTION"]
       : [searchField];

     // ğŸ”„ ìì—°ì–´ ì²˜ë¦¬ ì¤‘ í‘œì‹œ ON
     $("#nlpLoading").show();
     $("#recipeCards").empty(); // ì´ì „ ê²°ê³¼ ì œê±°

     $.ajax({
       url: ctx + "/recipes/search",
       type: "GET",
       data: {
         page: currentPage,
         keyword,
         fields,
         sort: currentSort,
         category: currentCategory,
         ajax: true
       },
       traditional: true,
       dataType: "json",
       success(res) {
         renderRecipeList(res.list || []);
         renderPaging(res.paging);
         $("#recipeCount").text(res.totalCount ?? res.list?.length ?? 0);

         requestAnimationFrame(() => {
           window.scrollTo(0, lastScrollTop);
         });
       },
       complete() {
         // ğŸ”„ ìì—°ì–´ ì²˜ë¦¬ ì¤‘ í‘œì‹œ OFF
         $("#nlpLoading").hide();
         isSearching = false;
       }
     });
   }


/* =====================================================
 * ì¹´ë“œ + ëª¨ë‹¬ ë Œë”ë§ (ì¸ë¶„ í‘œì‹œ ì¶”ê°€ ë²„ì „)
 * ===================================================== */
function renderRecipeList(list) {
    $("#recipeCards").empty();

    if (!list.length) {
        $("#recipeCards").html('<div class="status-msg">ì¡°ê±´ì— ë§ëŠ” ë ˆì‹œí”¼ê°€ ì—†ìŠµë‹ˆë‹¤. ğŸ˜¥</div>');
        return;
    }

    list.forEach(r => {
        const imgPath = r.image ? ctx + "/upload/" + r.image : "https://via.placeholder.com/300x200?text=No+Image";
        const diffClass = r.difficulty === "ì‰¬ì›€" ? "difficulty-easy" : r.difficulty === "ë³´í†µ" ? "difficulty-medium" : "difficulty-hard";

        $("#recipeCards").append(`
            <div class="col-sm-6 col-md-4 col-lg-3">
                <div class="recipe-card shadow-sm" data-recipe-id="${r.recipeId}">
                    <div class="position-relative">
                        <img src="${imgPath}" alt="${r.title}">
                        <div class="position-absolute top-0 start-0 m-2">
                             <span class="category-label">${r.categoryName || "ê¸°íƒ€"}</span>
                        </div>
                    </div>
                    
                    <div class="card-content">
                        <h5 class="mb-2 fw-bold text-dark text-truncate">${r.title}</h5>
                        <p class="recipe-description mb-3">${r.description || "ë§›ìˆëŠ” ë ˆì‹œí”¼ ì„¤ëª…ì„ í™•ì¸í•´ë³´ì„¸ìš”."}</p>

                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="difficulty-box ${diffClass}">${r.difficulty || "ë³´í†µ"}</span>
                            <div class="small text-muted">
                                <span>ğŸ‘ ${r.views || 0}</span>
                                <button class="like-inline-btn ms-2 ${r.likedByMe === 1 ? 'liked' : ''}" 
                                        data-recipe-id="${r.recipeId}" data-liked="${r.likedByMe}" 
                                        onclick="toggleLike(event, this)">
                                    <span class="heart">${r.likedByMe === 1 ? 'â™¥' : 'â™¡'}</span>
                                    <span class="like-count">${r.likeCount ?? 0}</span>
                                </button>
                            </div>
                        </div>

                        <div class="pt-2 border-top d-flex justify-content-between align-items-center">
                            <div class="small text-secondary">
                                <span class="me-2">â± ${r.cookTime || 0}ë¶„</span>
                                <span>ğŸ‘¨â€ğŸ³ ${r.servings || 0}ì¸ë¶„</span>
                            </div>
                            <span class="small fw-bold" style="color:#8B4513;">by ${r.nickname || "ì‘ì„±ì"}</span>
                        </div>
                    </div>
                </div>
            </div>
            ${renderRecipeModal(r, diffClass, imgPath)}
        `);
    });
}
/* =====================================================
 * ì¢‹ì•„ìš” í† ê¸€ ë° CSRF ì„¤ì •
 * ===================================================== */
const token = document.querySelector('meta[name="_csrf"]')?.content;
const header = document.querySelector('meta[name="_csrf_header"]')?.content;

function toggleLike(e, btn) {
    e.stopPropagation();
    const isAuth = document.querySelector('meta[name="isAuthenticated"]').content === 'true';

    if (!isAuth) {
        alert("ë¡œê·¸ì¸ í›„ ë”°ëœ»í•œ ê´€ì‹¬ì„ í‘œí˜„í˜„í•´ì£¼ì„¸ìš”! â¤ï¸");
        return;
    }

    const recipeId = btn.dataset.recipeId;
    const heart = btn.querySelector('.heart');
    const countSpan = btn.querySelector('.like-count');
    const liked = btn.dataset.liked === '1';
    const url = liked ? '/recipes/unlike' : '/recipes/like';

    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            [header]: token
        },
        body: `recipeId=${recipeId}`
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            heart.textContent = liked ? 'â™¡' : 'â™¥';
            countSpan.textContent = data.likes;
            btn.dataset.liked = liked ? '0' : '1';
            btn.classList.toggle('liked', !liked);
        }
    });
}

/* =====================================================
 * ëª¨ë‹¬ ìƒì„± (ì¬ë£Œ ë° ì¡°ë¦¬ ìˆœì„œ í¬í•¨)
 * ===================================================== */
function renderRecipeModal(r, diffClass, imgPath) {
    const ingredientsHtml = (r.ingredients || []).map(i => {
        const mId = i.materialid || i.materialId || i.id || null;
        const detailUrl = mId ? `/material/materialdetail?materialid=${mId}` : `/material/materialdetail?title=${encodeURIComponent(i.ingreName)}`;
        return `<li class="mb-2"><a href="${detailUrl}" class="text-decoration-none fw-bold" style="color:#8B4513;">[ì¬ë£Œ] ${i.ingreName} - ${i.ingreNum}</a></li>`;
    }).join("");

    const stepsHtml = (r.steps || []).map((s, idx) => `
        <div class="mb-3 p-3 rounded" style="background:#FDF5E6;">
            <strong style="color:#8B4513;">STEP ${idx + 1}</strong>
            <p class="mb-0 mt-1">${s.stepDesc || ""}</p>
        </div>`).join("");
    
 // --- ì—¬ê¸°ë¶€í„° ë¦¬ë·° ëª©ë¡ ìƒì„± ì½”ë“œ ì¶”ê°€ ---
    const reviewsHtml = (r.reviews && r.reviews.length > 0) ? r.reviews.map(rev => `
        <div class="py-2 border-bottom">
            <div class="d-flex justify-content-between align-items-center mb-1">
                <span class="fw-bold small" style="color:#8B4513;">${rev.nickname || 'ìµëª…'}</span>
                <span class="text-warning small">â˜… ${rev.rating}</span>
            </div>
            <p class="small mb-0 text-secondary">${rev.commentText}</p>
        </div>
    `).join("") : `<p class="text-muted small py-3 text-center">ë“±ë¡ëœ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>`;
    // --- ì—¬ê¸°ê¹Œì§€ ---
    

    return `
    <div class="modal fade" id="recipeModal${r.recipeId}" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content border-0">
                <div class="modal-header border-0 pb-0 d-flex flex-column align-items-start">
                    <h5 class="modal-title fw-bold">
                        <a href="/recipes/detail?recipeId=${r.recipeId}" class="text-dark text-decoration-none">${r.title}</a>
                    </h5>
                    <small class="text-muted" style="font-size: 0.8rem; margin-top: 5px;">ì œëª©ì„ í´ë¦­í•˜ë©´ ìƒì„¸ë³´ê¸°ë¡œ ì´ë™í•©ë‹ˆë‹¤.</small>
                    <button class="btn-close position-absolute top-0 end-0 m-3" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <img src="${imgPath}" class="modal-img shadow-sm mb-3" style="width:100%; border-radius:15px;" alt="${r.title}">
                    <div class="mb-3">
                        <span class="category-label me-2">${r.categoryName || "ê¸°íƒ€"}</span>
                        <span class="difficulty-box ${diffClass}">${r.difficulty || "ë³´í†µ"}</span>
                    </div>
                    <p class="lead" style="font-size:1rem;">${r.description || ""}</p>
                    <hr>
                    <h6>ğŸ§‚ ì¤€ë¹„ ì¬ë£Œ</h6>
                    <ul class="list-unstyled">${ingredientsHtml || "<li>ì •ë³´ ì—†ìŒ</li>"}</ul>
                    <hr>
                    <h6>ğŸ³ ì¡°ë¦¬ ìˆœì„œ</h6>
                    ${stepsHtml || "<p>ì •ë³´ ì—†ìŒ</p>"}
                    
                    <hr class="mt-4">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="fw-bold mb-0">ğŸ’¬ ë¦¬ë·° ëª©ë¡</h6>
                        <a href="/recipes/detail?recipeId=${r.recipeId}" class="small text-muted text-decoration-none">ìƒì„¸ë³´ê¸° ></a>
                    </div>
                    <div class="review-section p-3 rounded" style="background-color: #f8f9fa;">
                        ${reviewsHtml}
                    </div>
                    
                    
                </div>
            </div>
        </div>
    </div>`;
}






/* =====================================================
 * í˜ì´ì§• ì²˜ë¦¬
 * ===================================================== */
 function renderPaging(p){
     $("#pagingArea").empty();
     if(!p || p.pagetotal <= 1) return;

     const ul = $('<ul class="pagination justify-content-center"></ul>');

     // ì´ì „ ë²„íŠ¼
     if(p.current > 1){
       ul.append(`<li class="page-item"><a class="page-link" data-page="${p.current-1}">ì´ì „</a></li>`);
     }

     // í˜ì´ì§€ ë²ˆí˜¸ (í•­ìƒ ëë²ˆí˜¸ê¹Œì§€ í‘œì‹œ)
     for(let i = 1; i <= p.pagetotal; i++){
       ul.append(`
         <li class="page-item ${i === p.current ? "active" : ""}">
           <a class="page-link" data-page="${i}">${i}</a>
         </li>
       `);
     }

     // ë‹¤ìŒ ë²„íŠ¼
     if(p.current < p.pagetotal){
       ul.append(`<li class="page-item"><a class="page-link" data-page="${p.current+1}">ë‹¤ìŒ</a></li>`);
     }

     $("#pagingArea").append(ul);
   }

/* =====================================================
 * ì´ë²¤íŠ¸ ë°”ì¸ë”©
 * ===================================================== */
 $(function(){

     runSearch(1);

     $(document).on('click', '.recipe-card', function (e) {

        // â¤ï¸ ì¢‹ì•„ìš” ë²„íŠ¼ í´ë¦­ì´ë©´ ë¬´ì‹œ
        if ($(e.target).closest('.like-inline-btn').length > 0) {
          return;
        }

        const recipeId = $(this).data('recipe-id');
        const modalEl = document.getElementById('recipeModal' + recipeId);

        if (!modalEl) return;

        // ğŸ”‘ ê¸°ì¡´ ì¸ìŠ¤í„´ìŠ¤ ì¬ì‚¬ìš© (ì¤‘ìš”)
        let modal = bootstrap.Modal.getInstance(modalEl);
        if (!modal) {
          modal = new bootstrap.Modal(modalEl, {
            backdrop: true,
            keyboard: true
          });
        }

        modal.show();
      });
      
   //ë ˆì‹œí”¼ ë“±ë¡ ë²„íŠ¼ ì²˜ë¦¬
     $("#registerBtn").on("click", function () {
       const isAuth = document
         .querySelector('meta[name="isAuthenticated"]')
         .content === 'true';

       if (!isAuth) {
         alert("ë¡œê·¸ì¸ í›„ ë ˆì‹œí”¼ë¥¼ ë“±ë¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
         location.href = "/users/login";
         return;
       }

       location.href = "/recipes/register";
     });

     
   //===============================
   //ëª¨ë‹¬ ë‹«í ë•Œ backdrop ê°•ì œ ì •ë¦¬
   //===============================
   $(document).on('hidden.bs.modal', '.modal', function () {
    $('.modal-backdrop').remove();
    $('body').removeClass('modal-open');
    $('body').css('overflow', '');
   });



     
   $("#searchBtn").on("click", () => runSearch(1));

   //âŒ mousedown ì œê±°
   //$("#searchBtn").on("mousedown", e => e.preventDefault());

   //âœ… focusë§Œ ì œê±°
   $("#searchBtn").on("focus", function () {
   this.blur();
   });

     $("#search").on("keypress", function (e) {
        if (e.which === 13) {
          runSearch(1);
        }
      });

     $("#searchField").on("change", function (e) {
        e.preventDefault();
        runSearch(1);
      });


     $(".filter-btn").on("click", function(){
       $(".filter-btn").removeClass("active");
       $(this).addClass("active");
       currentCategory = $(this).data("filter") || null;
       runSearch(1);
     });

     $(".sort-btn").on("click", function(){
       $(".sort-btn").removeClass("active");
       $(this).addClass("active");
       currentSort = $(this).data("sort");
       runSearch(1);
     });
     
     $(document).on("click", "#pagingArea .page-link", function(e){
       e.preventDefault();
       const page = $(this).data("page");
       if(page) runSearch(page);
     });
     $(document).on('click', '.recipe-card', function (e) {

        // â¤ï¸ ì¢‹ì•„ìš” ë²„íŠ¼ í´ë¦­ì´ë©´ ë¬´ì‹œ
        if ($(e.target).closest('.like-inline-btn').length > 0) {
          return;
        }

        const recipeId = $(this).data('recipe-id');
        const modalEl = document.getElementById('recipeModal' + recipeId);

        if (modalEl) {
          const modal = new bootstrap.Modal(modalEl);
          modal.show();
        }
      });
	  
	  //===============================
	     //ì¶”ì²œ ê¸°ëŠ¥ (ìˆ˜ì • ì™„ë£Œ)
	     //===============================
	  
	  $("#recommendBtn").click(function() {
	                // [ìˆ˜ì •] HTMLì— ì„ ì–¸ëœ ì‹¤ì œ ID ê°’ì¸ recCategoryì™€ recKeywordë¥¼ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.
	                let category = $("#recCategory").val(); 
	                let keyword = $("#recKeyword").val();
					let highQuality = $("#highQualityToggle").is(":checked");

	                $.ajax({
	                    url: "/recipes/recommend",
	                    type: "GET",
	                    data: { category: category, keyword: keyword,highQuality: highQuality },
	                    success: function(data) {
							if (!data || !data.recipeId) {
							                // í† ê¸€ì´ ì¼œì ¸ ìˆì„ ë•Œ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ë©”ì‹œì§€ë¥¼ ë” êµ¬ì²´ì ìœ¼ë¡œ ì¤„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
							                let msg = highQuality ? "ì¡°ê±´ì— ë§ëŠ” 'ì¸ê¸°' ë ˆì‹œí”¼ê°€ ì—†ìŠµë‹ˆë‹¤. ğŸ˜¥" : "ì¡°ê±´ì— ë§ëŠ” ë ˆì‹œí”¼ê°€ ì—†ìŠµë‹ˆë‹¤. ğŸ˜¥";
							                alert(msg);
							                $("#recommendDisplay").hide();
							                return;
							            }
							

	                        // ë°ì´í„° ì±„ìš°ê¸°
	                        $("#recTitle").text(data.title);
	                        $("#recNickname").text(data.nickname || "ìµëª…");
	                        // [ìˆ˜ì •] IDê°€ recCategoryNameì¸ ìš”ì†Œì— ì¹´í…Œê³ ë¦¬ë¥¼ ë„£ì–´ì•¼ í•©ë‹ˆë‹¤.
	                        $("#recCategoryName").text(data.categoryName || "ê¸°íƒ€");
	                        $("#recViews").text(data.views || 0);
	                        
	                        // ì´ë¯¸ì§€ ì²˜ë¦¬
	                        let imgPath = data.image ? "/upload/" + data.image : "https://via.placeholder.com/300x200?text=No+Image";
	                        $("#recImage").attr("src", imgPath);
	                        
	                        // ë§í¬ ì—°ê²°
	                        $("#recLink").attr("href", "/recipes/detail?recipeId=" + data.recipeId);
	                        
	                        // ê²°ê³¼ì°½ ë…¸ì¶œ
	                        $("#recommendDisplay").slideDown();
	                        
	                        // ì¶”ì²œ ê²°ê³¼ ìœ„ì¹˜ë¡œ í™”ë©´ ìŠ¤í¬ë¡¤
	                       // $('html, body').animate({
	                         //   scrollTop: $("#recommendDisplay").offset().top - 150
	                        //}, 500);
	                    },
	                    error: function(xhr) {
	                        alert("ì¡°ê±´ì— ë¶€í•©í•˜ëŠ” ë ˆì‹œí”¼ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ê²€ìƒ‰ì–´ë¥¼ ì‹œë„í•´ë³´ì„¸ìš”!");
	                        $("#recommendDisplay").hide();
	                    }
	                });
	            });
   });
  
      </script>
   </div>
</body>
</html>