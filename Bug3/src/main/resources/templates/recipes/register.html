<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{fragments/layout}">
<head lang="ko">
    <meta charset="UTF-8">
    <title>ë ˆì‹œí”¼ ë“±ë¡</title>
    <style>
        /* ì „ì²´ ë°°ê²½ ë° ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
        .register-wrapper {
            max-width: 850px;
            margin: 50px auto;
            padding: 40px;
            background: #ffffff;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(139, 69, 19, 0.08);
            border: 1px solid #f1e4d3;
        }
        
        .page-title {
            color: #4A3728;
            font-weight: 800;
            font-size: 1.8rem;
            margin-bottom: 40px;
            border-bottom: 3px solid #FDF5E6;
            padding-bottom: 15px;
        }

        /* ì„¹ì…˜ êµ¬ë¶„ ì œëª© */
        .section-label {
            font-weight: 700;
            color: #8B4513;
            font-size: 1.1rem;
            margin-bottom: 12px;
            display: block;
        }

        /* ì…ë ¥ì°½ ê³µí†µ ìŠ¤íƒ€ì¼ */
        .form-control, .form-select {
            border-radius: 12px;
            border: 1px solid #D2B48C;
            padding: 12px 15px;
            transition: all 0.3s ease;
        }

        .form-control:focus, .form-select:focus {
            border-color: #8B4513;
            box-shadow: 0 0 0 0.2rem rgba(139, 69, 19, 0.1);
            outline: none;
        }

        /* ë‹¨ê³„ë³„ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .step-row {
            background-color: #FDFDFD;
            border: 1px solid #EADDCA !important;
            border-radius: 15px !important;
            padding: 20px !important;
            margin-bottom: 20px;
        }

        /* íŒŒì¼ ì…ë ¥ì°½ ë””ìì¸ ìˆ˜ì • */
        .step-file-input {
            margin-top: 10px;
            border: 1px dashed #D2B48C !important;
            background-color: #FAFAFA !important;
            padding: 8px !important;
        }

        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì»¤ìŠ¤í…€ */
        .btn-warning {
            background-color: #8B4513 !important;
            border: none !important;
            color: white !important;
            font-weight: 700 !important;
            padding: 12px 30px !important;
            border-radius: 12px !important;
        }

        .btn-outline-primary {
            color: #8B4513 !important;
            border-color: #8B4513 !important;
            background: #fff !important;
            font-weight: 600;
        }

        .btn-outline-primary:hover {
            background: #8B4513 !important;
            color: #fff !important;
        }

        .btn-outline-success {
            color: #2E7D32 !important;
            border-color: #A5D6A7 !important;
            font-weight: 600;
        }

        .btn-outline-success:hover {
            background: #E8F5E9 !important;
        }

        /* ì¬ë£Œ ì‚­ì œ ë²„íŠ¼ */
        .btn-remove-ingre {
            height: 100%;
            border-radius: 10px !important;
        }

        /* ê°„ê²© ì¡°ì • */
        .mb-section {
            margin-bottom: 35px;
        }
    </style>
</head>

<body>
<div layout:fragment="content" class="container mt-5">
    <div class="register-wrapper">
        <h3 class="page-title">ğŸ³ ìƒˆ ë ˆì‹œí”¼ ì‘ì„±</h3>

        <form th:action="@{/recipes/register}" method="post" enctype="multipart/form-data">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

            <div class="mb-section">
                <label class="section-label">ë ˆì‹œí”¼ ì œëª© *</label> 
                <input type="text" class="form-control" name="title" placeholder="ë§›ê¹”ë‚˜ëŠ” ìš”ë¦¬ ì´ë¦„ì„ ì§€ì–´ì£¼ì„¸ìš”" required>
            </div>

            <div class="row mb-section">
                <div class="col-md-6 mb-3">
                    <label class="section-label">ì¹´í…Œê³ ë¦¬ *</label> 
                    <select name="category" class="form-select" required>
                        <option value="">ì„ íƒ</option>
                        <option value="2">í•œì‹</option>
                        <option value="3">ì–‘ì‹</option>
                        <option value="4">ì¤‘ì‹</option>
                        <option value="5">ì¼ì‹</option>
                        <option value="6">ë””ì €íŠ¸</option>
                        <option value="7">ê±´ê°•ì‹</option>
                        <option value="8">ê¸°íƒ€</option>
                    </select>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="section-label">ë‚œì´ë„ *</label> 
                    <select name="difficulty" class="form-select" required>
                        <option value="ì‰¬ì›€">ì‰¬ì›€</option>
                        <option value="ë³´í†µ" selected>ë³´í†µ</option>
                        <option value="ì–´ë ¤ì›€">ì–´ë ¤ì›€</option>
                    </select>
                </div>
            </div>

            <div class="row mb-section">
                <div class="col-md-6 mb-3">
                    <label class="section-label">ì¡°ë¦¬ ì‹œê°„(ë¶„)</label> 
                    <input type="number" class="form-control" name="cookTime" value="30" required>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="section-label">ì¸ë¶„</label> 
                    <input type="number" class="form-control" name="servings" value="2" required>
                </div>
            </div>

            <div class="mb-section">
                <label class="section-label">ğŸ–¼ï¸ ëŒ€í‘œ ì´ë¯¸ì§€</label> 
                <input type="file" class="form-control" name="imageFile" required>
            </div>

            <div class="mb-section">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <label class="section-label mb-0">ë ˆì‹œí”¼ ì„¤ëª… *</label>
                    <button type="button" class="btn btn-sm btn-outline-success" id="autoDescSimpleBtn">âœ¨ AI ê°„ë‹¨ ì„¤ëª…</button>
                </div>
                <textarea class="form-control" id="description" name="description" rows="3" placeholder="ì´ ìš”ë¦¬ì˜ ë§¤ë ¥ì„ í•œë§ˆë””ë¡œ ì†Œê°œí•´ì£¼ì„¸ìš”" required></textarea>
            </div>

            <div class="mb-section">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <label class="section-label mb-0">ğŸ§‚ ì¬ë£Œ ì •ë³´ *</label>
                    <button type="button" class="btn btn-sm btn-outline-primary" id="addIngredientBtn">+ ì¬ë£Œ ì¶”ê°€</button>
                </div>
                
                <div id="ingredientsContainer">
                    <div class="row g-2 mb-2 ingredient-row align-items-stretch">
                        <div class="col-5">
                            <input type="text" class="form-control" name="ingredients[0].ingreName" placeholder="ì¬ë£Œëª… (ì˜ˆ: ë¼ì§€ê³ ê¸°)" required>
                        </div>
                        <div class="col-5">
                            <input type="text" class="form-control" name="ingredients[0].ingreNum" placeholder="ì–‘ (ì˜ˆ: 300g)" required>
                        </div>
                        <div class="col-2 d-grid">
                            <button type="button" class="btn btn-outline-danger btn-remove-ingre">ì‚­ì œ</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mb-section">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <label class="section-label mb-0">ğŸ‘¨â€ğŸ³ ì¡°ë¦¬ ë°©ë²• *</label>
                    <div>
                        <button type="button" class="btn btn-sm btn-outline-success me-2" id="autoStepBtn">ğŸ¤– AI ë‹¨ê³„ ìƒì„±</button>
                        <button type="button" class="btn btn-sm btn-outline-primary" id="addStepBtn">+ ë‹¨ê³„ ì¶”ê°€</button>
                    </div>
                </div>

                <div id="stepsContainer">
                    <div class="card step-row shadow-sm">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="section-label mb-0" style="font-size: 0.9rem;">1ë‹¨ê³„</label>
                            <button type="button" class="btn btn-sm text-danger btn-remove-step">ì‚­ì œ</button>
                        </div>
                        <textarea class="form-control mb-2" name="steps[0].stepDesc" rows="2" placeholder="ì¡°ë¦¬ ë°©ë²•ì„ ìƒì„¸íˆ ì ì–´ì£¼ì„¸ìš”" required></textarea>
                        <input type="file" name="stepImages" class="form-control step-file-input">
                    </div>
                </div>
            </div>

            <div class="mb-section">
                <label class="section-label">ğŸ”— ë ˆì‹œí”¼ ì°¸ê³  URL</label> 
                <input type="text" class="form-control" name="rUrl" placeholder="ì°¸ê³ í•œ ì˜ìƒì´ë‚˜ ë¸”ë¡œê·¸ê°€ ìˆë‹¤ë©´ ì ì–´ì£¼ì„¸ìš”">
            </div>

            <input type="hidden" name="status" value="PUBLIC">

            <div class="text-center mt-5">
                <button type="submit" class="btn btn-warning shadow-sm">ì‘ì„± ì™„ë£Œ ë° ë“±ë¡</button>
            </div>
        </form>
    </div>

<script th:inline="javascript">
    const ingreBox = document.getElementById('ingredientsContainer');
    const stepBox = document.getElementById('stepsContainer');

    function reindexIngredients() {
        document.querySelectorAll('.ingredient-row').forEach((row, idx) => {
            row.querySelector('[name$="ingreName"]').name = `ingredients[${idx}].ingreName`;
            row.querySelector('[name$="ingreNum"]').name = `ingredients[${idx}].ingreNum`;
        });
    }

    function reindexSteps() {
        document.querySelectorAll('.step-row').forEach((row, idx) => {
            row.querySelector('.section-label').textContent = `${idx + 1}ë‹¨ê³„`;
            row.querySelector('textarea').name = `steps[${idx}].stepDesc`;
        });
    }

    // ì¬ë£Œ ì¶”ê°€
   document.getElementById('addIngredientBtn').onclick = () => {
    const idx = document.querySelectorAll('.ingredient-row').length;

    const div = document.createElement('div');
    div.className = 'row g-2 mb-2 ingredient-row align-items-stretch';
    div.innerHTML = `
        <div class="col-5">
            <input class="form-control"
                   name="ingredients[${idx}].ingreName"
                   placeholder="ì¬ë£Œëª…" required>
        </div>
        <div class="col-5">
            <input class="form-control"
                   name="ingredients[${idx}].ingreNum"
                   placeholder="ì–‘" required>
        </div>
        <div class="col-2 d-grid">
            <button type="button" class="btn btn-outline-danger btn-remove-ingre">ì‚­ì œ</button>
        </div>
    `;
    ingreBox.appendChild(div);
};


    ingreBox.onclick = e => {
        if (e.target.classList.contains('btn-remove-ingre')) {
            if(document.querySelectorAll('.ingredient-row').length > 1) {
                e.target.closest('.ingredient-row').remove();
                reindexIngredients();
            }
        }
    };

    // ë‹¨ê³„ ì¶”ê°€
    document.getElementById('addStepBtn').onclick = () => {
        const idx = document.querySelectorAll('.step-row').length;
        const div = document.createElement('div');
        div.className = 'card step-row shadow-sm';
        div.innerHTML = `
            <div class="d-flex justify-content-between align-items-center mb-2">
                <label class="section-label mb-0" style="font-size: 0.9rem;">${idx + 1}ë‹¨ê³„</label>
                <button type="button" class="btn btn-sm text-danger btn-remove-step">ì‚­ì œ</button>
            </div>
            <textarea class="form-control mb-2" name="steps[${idx}].stepDesc" rows="2" placeholder="ì¡°ë¦¬ ë°©ë²•ì„ ìƒì„¸íˆ ì ì–´ì£¼ì„¸ìš”" required></textarea>
            <input type="file" name="stepImages" class="form-control step-file-input">
        `;
        stepBox.appendChild(div);
    };

    stepBox.onclick = e => {
        if (e.target.classList.contains('btn-remove-step')) {
            if(document.querySelectorAll('.step-row').length > 1) {
                e.target.closest('.step-row').remove();
                reindexSteps();
            }
        }
    };

    // AI ìë™ ë‹¨ê³„ ìƒì„±
    document.getElementById('autoStepBtn').onclick = () => {
        const title = document.querySelector('[name="title"]').value;
        const shortDesc = document.getElementById('description').value;
        const ingredients = Array.from(document.querySelectorAll('[name$="ingreName"]'))
                                 .map(el => el.value).filter(v => v);

        if(!title) { alert('ì œëª©ì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }

        fetch('/recipes/auto-steps', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': document.querySelector('input[name="_csrf"]').value
            },
            body: JSON.stringify({ title, shortDesc, ingredients })
        })
        .then(res => res.json())
        .then(data => {
            const steps = data.steps.split('\n').filter(s => s.trim() !== '');
            stepBox.innerHTML = '';
            steps.forEach((step, idx) => {
                const div = document.createElement('div');
                div.className = 'card step-row shadow-sm';
                div.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <label class="section-label mb-0" style="font-size: 0.9rem;">${idx + 1}ë‹¨ê³„</label>
                        <button type="button" class="btn btn-sm text-danger btn-remove-step">ì‚­ì œ</button>
                    </div>
                    <textarea class="form-control mb-2" name="steps[${idx}].stepDesc" rows="2" required>${step}</textarea>
                    <input type="file" name="stepImages" class="form-control step-file-input">
                `;
                stepBox.appendChild(div);
            });
        })
        .catch(err => alert('AI ë‹¨ê³„ ìƒì„± ì‹¤íŒ¨'));
    };

    // AI ìë™ ì„¤ëª… ìƒì„±
    document.getElementById('autoDescSimpleBtn').onclick = () => {
        const title = document.querySelector('[name="title"]').value;
        if(!title) { alert('ì œëª©ì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }

        fetch('/recipes/auto-description', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': document.querySelector('input[name="_csrf"]').value
            },
            body: JSON.stringify({ title, mode: 'simple' })
        })
        .then(res => res.json())
        .then(data => document.getElementById('description').value = data.description)
        .catch(err => alert('ì„¤ëª… ìƒì„± ì‹¤íŒ¨'));
    };
</script>
</div>
</body>
</html>