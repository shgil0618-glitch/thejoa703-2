name: Deploy Fullstack App   # 워크플로우 이름 정의

on:     # 실행조건 정의
  push:    # push 이벤트 발생시 실행
    branches:   
      - main   # main 브랜치에 push 될 때만 실행     

jobs:       # 실행할 job 정의
  
  legacy-boot:
    runs-on: ubuntu-latest
    steps:
      # 1. 코드 체크아웃
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. JDK 11 설정
      - name: Set up JDK 11
        uses: actions/setup-java@v3
        with:
          java-version: '11'
          distribution: 'temurin'

      # 3. Maven 빌드
      - name: Build Legacy Boot App
        run: mvn clean package -DskipTests
        working-directory: Bug3  # <-- 여기를 Bug3로 수정
        # working-directory: legacy-boot

      # 4. Secrets에서 .env 복원 (CI 러너 루트에 파일 생성)   
      - name: Restore .env from Secrets
        run: |
          echo "${{ secrets.LEGACY_ENV }}" > .env
          ls -al .env   # 파일인지 확인용 로그
          head -n 5 .env   # 내용 일부 확인 (마스킹됨)

      # 5. EC2에 target 디렉토리 생성
      - name: Ensure legacy-boot directory exists on EC2
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: mkdir -p /home/ubuntu/legacy-boot/target

      # 6. 빌드된 JAR 파일 복사 (경로 중첩 방지 → strip_components 사용)
      - name: Copy Legacy Boot JAR to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "Bug3/target/*.jar" # <--- Bug3로 변경
          # source: "legacy-boot/target/*.jar"
          target: "/home/ubuntu/legacy-boot/target/"
          strip_components: 2   # legacy-boot/target 경로 제거 후 JAR만 복사

      # 7. 기존 .env 디렉토리 삭제 (있으면 제거)
      - name: Remove existing .env directory on EC2
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: rm -rf /home/ubuntu/legacy-boot/.env

      # 8. .env 파일 복사 (파일로 확실히 반영)   
      - name: Copy Legacy Boot .env to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: ".env"
          target: "/home/ubuntu/legacy-boot"
          # ⬆️ target을 디렉토리로 지정 → EC2에 /home/ubuntu/legacy-boot/.env 파일 생성

      # 9. pm2로 실행  
      - name: Run Legacy Boot on EC2 with pm2
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd /home/ubuntu/legacy-boot
            pm2 delete legacy-boot || true

            ls -al .env

            # 안전하게 .env 로드
            set -a
            . ./.env
            set +a

            JAR_FILE=/home/ubuntu/legacy-boot/target/boot001-0.0.1-SNAPSHOT.jar

            pm2 start java --name legacy-boot -- \
              -Doracle.jdbc.timezoneAsRegion=false \
              -Duser.timezone=Asia/Seoul \
              -jar /home/ubuntu/legacy-boot/target/boot001-0.0.1-SNAPSHOT.jar